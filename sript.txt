<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCM Audio Recorder</title>
</head>
<body>
    <h1>PCM Audio Recorder</h1>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>

    <script>
        let mediaRecorder;
        let audioContext;
        let sourceNode;
        let scriptProcessor;

        document.getElementById('startBtn').onclick = () => {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    audioContext = new AudioContext();
                    sourceNode = audioContext.createMediaStreamSource(stream);
                    scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                    scriptProcessor.onaudioprocess = event => {
                        const inputBuffer = event.inputBuffer;
                        const pcmData = inputBuffer.getChannelData(0);
                        sendAudioData(pcmData);
                    };

                    sourceNode.connect(scriptProcessor);
                    scriptProcessor.connect(audioContext.destination);

                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                });
        };

        document.getElementById('stopBtn').onclick = () => {
            scriptProcessor.disconnect();
            sourceNode.disconnect();
            audioContext.close();

            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        };

        function sendAudioData(pcmData) {
            const socket = new WebSocket('ws://localhost:8765');

            socket.binaryType = 'arraybuffer';
            socket.onopen = () => {
                const float32Array = new Float32Array(pcmData);
                socket.send(float32Array.buffer);
            };

            socket.onerror = error => {
                console.error('WebSocket error:', error);
            };
        }
    </script>
</body>
</html>
